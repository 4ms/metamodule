#pragma once

#include "processors/tools/windowComparator.h"
#include "util/math.hh"

using namespace MathTools;

class Envelope {
private:
	float expoCurve[2048] = {
		0,			 2.38652e-07, 9.54606e-07, 2.14786e-06, 3.81843e-06, 5.96629e-06, 8.59146e-06, 1.16939e-05,
		1.52737e-05, 1.93308e-05, 2.38652e-05, 2.88768e-05, 3.43658e-05, 4.03321e-05, 4.67757e-05, 5.36966e-05,
		6.10948e-05, 6.89703e-05, 7.73231e-05, 8.61532e-05, 9.54606e-05, 0.000105245, 0.000115507, 0.000126247,
		0.000137463, 0.000149157, 0.000161328, 0.000173977, 0.000187103, 0.000200706, 0.000214786, 0.000229344,
		0.000244379, 0.000259892, 0.000275881, 0.000292348, 0.000309292, 0.000326714, 0.000344613, 0.000362989,
		0.000381843, 0.000401173, 0.000420981, 0.000441267, 0.000462029, 0.000483269, 0.000504987, 0.000527181,
		0.000549853, 0.000573002, 0.000596629, 0.000620733, 0.000645314, 0.000670372, 0.000695908, 0.000721921,
		0.000748411, 0.000775379, 0.000802824, 0.000830746, 0.000859146, 0.000888023, 0.000917377, 0.000947208,
		0.000977517, 0.0010083,	  0.00103957,  0.00107131,	0.00110352,	 0.00113622,  0.00116939,  0.00120304,
		0.00123717,	 0.00127177,  0.00130686,  0.00134241,	0.00137845,	 0.00141497,  0.00145196,  0.00148942,
		0.00152737,	 0.00156579,  0.00160469,  0.00164407,	0.00168393,	 0.00172426,  0.00176507,  0.00180635,
		0.00184812,	 0.00189036,  0.00193308,  0.00197627,	0.00201995,	 0.0020641,	  0.00210873,  0.00215383,
		0.00219941,	 0.00224547,  0.00229201,  0.00233902,	0.00238652,	 0.00243448,  0.00248293,  0.00253185,
		0.00258126,	 0.00263113,  0.00268149,  0.00273232,	0.00278363,	 0.00283542,  0.00288768,  0.00294043,
		0.00299365,	 0.00304734,  0.00310152,  0.00315617,	0.0032113,	 0.0032669,	  0.00332298,  0.00337955,
		0.00343658,	 0.0034941,	  0.00355209,  0.00361056,	0.00366951,	 0.00372893,  0.00378883,  0.00384921,
		0.00391007,	 0.0039714,	  0.00403321,  0.0040955,	0.00415826,	 0.00422151,  0.00428523,  0.00434942,
		0.0044141,	 0.00447925,  0.00454488,  0.00461099,	0.00467757,	 0.00474463,  0.00481217,  0.00488019,
		0.00494868,	 0.00501765,  0.0050871,   0.00515702,	0.00522742,	 0.0052983,	  0.00536966,  0.00544149,
		0.00551381,	 0.00558659,  0.00565986,  0.0057336,	0.00580782,	 0.00588252,  0.0059577,   0.00603335,
		0.00610948,	 0.00618609,  0.00626317,  0.00634073,	0.00641877,	 0.00649729,  0.00657628,  0.00665575,
		0.0067357,	 0.00681613,  0.00689703,  0.00697841,	0.00706027,	 0.0071426,	  0.00722542,  0.0073087,
		0.00739247,	 0.00747672,  0.00756144,  0.00764664,	0.00773231,	 0.00781846,  0.00790509,  0.0079922,
		0.00807979,	 0.00816785,  0.00825639,  0.00834541,	0.0084349,	 0.00852487,  0.00861532,  0.00870625,
		0.00879765,	 0.00888953,  0.00898189,  0.00907473,	0.00916804,	 0.00926183,  0.0093561,   0.00945084,
		0.00954606,	 0.00964176,  0.00973794,  0.00983459,	0.00993172,	 0.0100293,	  0.0101274,   0.010226,
		0.010325,	 0.0104245,	  0.0105245,   0.010625,	0.010726,	 0.0108274,	  0.0109293,   0.0110317,
		0.0111345,	 0.0112379,	  0.0113417,   0.011446,	0.0115507,	 0.011656,	  0.0117617,   0.0118679,
		0.0119746,	 0.0120817,	  0.0121894,   0.0122975,	0.0124061,	 0.0125151,	  0.0126247,   0.0127347,
		0.0128452,	 0.0129562,	  0.0130676,   0.0131795,	0.0132919,	 0.0134048,	  0.0135182,   0.013632,
		0.0137463,	 0.0138611,	  0.0139764,   0.0140921,	0.0142084,	 0.0143251,	  0.0144422,   0.0145599,
		0.014678,	 0.0147966,	  0.0149157,   0.0150353,	0.0151553,	 0.0152758,	  0.0153968,   0.0155183,
		0.0156403,	 0.0157627,	  0.0158856,   0.016009,	0.0161328,	 0.0162572,	  0.016382,	   0.0165073,
		0.0166331,	 0.0167593,	  0.016886,	   0.0170132,	0.0171409,	 0.0172691,	  0.0173977,   0.0175268,
		0.0176564,	 0.0177865,	  0.017917,	   0.018048,	0.0181795,	 0.0183115,	  0.0184439,   0.0185769,
		0.0187103,	 0.0188442,	  0.0189785,   0.0191134,	0.0192487,	 0.0193845,	  0.0195207,   0.0196575,
		0.0197947,	 0.0199324,	  0.0200706,   0.0202093,	0.0203484,	 0.020488,	  0.0206281,   0.0207687,
		0.0209097,	 0.0210512,	  0.0211932,   0.0213357,	0.0214786,	 0.0216221,	  0.021766,	   0.0219104,
		0.0220552,	 0.0222006,	  0.0223464,   0.0224927,	0.0226394,	 0.0227867,	  0.0229344,   0.0230826,
		0.0232313,	 0.0233805,	  0.0235301,   0.0236802,	0.0238308,	 0.0239819,	  0.0241334,   0.0242854,
		0.0244379,	 0.0245909,	  0.0247444,   0.0248983,	0.0250527,	 0.0252076,	  0.0253629,   0.0255188,
		0.0256751,	 0.0258319,	  0.0259892,   0.0261469,	0.0263051,	 0.0264638,	  0.026623,	   0.0267827,
		0.0269428,	 0.0271034,	  0.0272645,   0.0274261,	0.0275881,	 0.0277506,	  0.0279136,   0.0280771,
		0.0282411,	 0.0284055,	  0.0285704,   0.0287358,	0.0289017,	 0.029068,	  0.0292348,   0.0294021,
		0.0295699,	 0.0297381,	  0.0299069,   0.0300761,	0.0302457,	 0.0304159,	  0.0305865,   0.0307577,
		0.0309292,	 0.0311013,	  0.0312739,   0.0314469,	0.0316204,	 0.0317944,	  0.0319688,   0.0321437,
		0.0323192,	 0.032495,	  0.0326714,   0.0328482,	0.0330256,	 0.0332034,	  0.0333816,   0.0335604,
		0.0337396,	 0.0339193,	  0.0340995,   0.0342802,	0.0344613,	 0.0346429,	  0.034825,	   0.0350076,
		0.0351906,	 0.0353741,	  0.0355581,   0.0357426,	0.0359276,	 0.036113,	  0.0362989,   0.0364853,
		0.0366722,	 0.0368595,	  0.0370473,   0.0372356,	0.0374244,	 0.0376136,	  0.0378034,   0.0379936,
		0.0381843,	 0.0383754,	  0.038567,	   0.0387592,	0.0389518,	 0.0391448,	  0.0393384,   0.0395324,
		0.0397269,	 0.0399219,	  0.0401173,   0.0403133,	0.0405097,	 0.0407066,	  0.0409039,   0.0411018,
		0.0413001,	 0.0414989,	  0.0416982,   0.0418979,	0.0420981,	 0.0422988,	  0.0425,	   0.0427017,
		0.0429038,	 0.0431064,	  0.0433095,   0.0435131,	0.0437171,	 0.0439217,	  0.0441267,   0.0443322,
		0.0445381,	 0.0447445,	  0.0449515,   0.0451588,	0.0453667,	 0.0455751,	  0.0457839,   0.0459932,
		0.0462029,	 0.0464132,	  0.0466239,   0.0468351,	0.0470468,	 0.047259,	  0.0474716,   0.0476847,
		0.0478983,	 0.0481124,	  0.0483269,   0.048542,	0.0487575,	 0.0489735,	  0.0491899,   0.0494068,
		0.0496243,	 0.0498421,	  0.0500605,   0.0502794,	0.0504987,	 0.0507185,	  0.0509388,   0.0511595,
		0.0513807,	 0.0516024,	  0.0518246,   0.0520473,	0.0522704,	 0.052494,	  0.0527181,   0.0529427,
		0.0531678,	 0.0533933,	  0.0536193,   0.0538458,	0.0540727,	 0.0543002,	  0.0545281,   0.0547565,
		0.0549853,	 0.0552147,	  0.0554445,   0.0556748,	0.0559056,	 0.0561368,	  0.0563685,   0.0566008,
		0.0568334,	 0.0570666,	  0.0573002,   0.0575344,	0.057769,	 0.058004,	  0.0582396,   0.0584756,
		0.0587121,	 0.0589491,	  0.0591865,   0.0594245,	0.0596629,	 0.0599018,	  0.0601412,   0.060381,
		0.0606213,	 0.0608621,	  0.0611034,   0.0613451,	0.0615874,	 0.0618301,	  0.0620733,   0.0623169,
		0.0625611,	 0.0628057,	  0.0630508,   0.0632964,	0.0635424,	 0.0637889,	  0.0640359,   0.0642834,
		0.0645314,	 0.0647798,	  0.0650287,   0.0652781,	0.065528,	 0.0657783,	  0.0660292,   0.0662805,
		0.0665322,	 0.0667845,	  0.0670372,   0.0672904,	0.0675441,	 0.0677983,	  0.0680529,   0.068308,
		0.0685636,	 0.0688197,	  0.0690763,   0.0693333,	0.0695908,	 0.0698488,	  0.0701072,   0.0703662,
		0.0706256,	 0.0708855,	  0.0711459,   0.0714067,	0.071668,	 0.0719298,	  0.0721921,   0.0724549,
		0.0727181,	 0.0729818,	  0.073246,	   0.0735106,	0.0737758,	 0.0740414,	  0.0743075,   0.0745741,
		0.0748411,	 0.0751087,	  0.0753767,   0.0756451,	0.0759141,	 0.0761836,	  0.0764535,   0.0767239,
		0.0769947,	 0.0772661,	  0.0775379,   0.0778102,	0.078083,	 0.0783562,	  0.07863,	   0.0789042,
		0.0791789,	 0.079454,	  0.0797297,   0.0800058,	0.0802824,	 0.0805595,	  0.080837,	   0.081115,
		0.0813935,	 0.0816725,	  0.081952,	   0.0822319,	0.0825123,	 0.0827932,	  0.0830746,   0.0833565,
		0.0836388,	 0.0839216,	  0.0842049,   0.0844886,	0.0847729,	 0.0850576,	  0.0853428,   0.0856284,
		0.0859146,	 0.0862012,	  0.0864883,   0.0867759,	0.0870639,	 0.0873524,	  0.0876414,   0.0879309,
		0.0882209,	 0.0885113,	  0.0888022,   0.0890936,	0.0893855,	 0.0896779,	  0.0899707,   0.090264,
		0.0905578,	 0.090852,	  0.0911468,   0.091442,	0.0917377,	 0.0920338,	  0.0923305,   0.0926276,
		0.0929252,	 0.0932233,	  0.0935218,   0.0938208,	0.0941204,	 0.0944203,	  0.0947208,   0.0950217,
		0.0953232,	 0.0956251,	  0.0959274,   0.0962303,	0.0965336,	 0.0968374,	  0.0971417,   0.0974464,
		0.0977517,	 0.0980574,	  0.0983636,   0.0986703,	0.0989774,	 0.099285,	  0.0995931,   0.0999017,
		0.100211,	 0.10052,	  0.10083,	   0.101141,	0.101452,	 0.101763,	  0.102075,	   0.102388,
		0.1027,		 0.103014,	  0.103328,	   0.103642,	0.103957,	 0.104272,	  0.104588,	   0.104904,
		0.105221,	 0.105538,	  0.105855,	   0.106173,	0.106492,	 0.106811,	  0.107131,	   0.107451,
		0.107771,	 0.108092,	  0.108414,	   0.108736,	0.109058,	 0.109381,	  0.109704,	   0.110028,
		0.110353,	 0.110677,	  0.111003,	   0.111328,	0.111655,	 0.111981,	  0.112308,	   0.112636,
		0.112964,	 0.113293,	  0.113622,	   0.113952,	0.114282,	 0.114612,	  0.114943,	   0.115275,
		0.115607,	 0.115939,	  0.116272,	   0.116605,	0.116939,	 0.117274,	  0.117608,	   0.117944,
		0.11828,	 0.118616,	  0.118953,	   0.11929,		0.119627,	 0.119966,	  0.120304,	   0.120643,
		0.120983,	 0.121323,	  0.121664,	   0.122005,	0.122346,	 0.122688,	  0.123031,	   0.123374,
		0.123717,	 0.124061,	  0.124405,	   0.12475,		0.125095,	 0.125441,	  0.125788,	   0.126134,
		0.126482,	 0.126829,	  0.127177,	   0.127526,	0.127875,	 0.128225,	  0.128575,	   0.128926,
		0.129277,	 0.129628,	  0.12998,	   0.130333,	0.130686,	 0.131039,	  0.131393,	   0.131747,
		0.132102,	 0.132458,	  0.132813,	   0.13317,		0.133527,	 0.133884,	  0.134242,	   0.1346,
		0.134958,	 0.135318,	  0.135677,	   0.136037,	0.136398,	 0.136759,	  0.137121,	   0.137483,
		0.137845,	 0.138208,	  0.138572,	   0.138936,	0.1393,		 0.139665,	  0.14003,	   0.140396,
		0.140762,	 0.141129,	  0.141497,	   0.141864,	0.142233,	 0.142601,	  0.14297,	   0.14334,
		0.14371,	 0.144081,	  0.144452,	   0.144824,	0.145196,	 0.145568,	  0.145941,	   0.146315,
		0.146689,	 0.147063,	  0.147438,	   0.147813,	0.148189,	 0.148566,	  0.148942,	   0.14932,
		0.149698,	 0.150076,	  0.150455,	   0.150834,	0.151213,	 0.151594,	  0.151974,	   0.152355,
		0.152737,	 0.153119,	  0.153502,	   0.153885,	0.154268,	 0.154652,	  0.155037,	   0.155422,
		0.155807,	 0.156193,	  0.156579,	   0.156966,	0.157353,	 0.157741,	  0.15813,	   0.158518,
		0.158908,	 0.159297,	  0.159687,	   0.160078,	0.160469,	 0.160861,	  0.161253,	   0.161646,
		0.162039,	 0.162432,	  0.162826,	   0.163221,	0.163616,	 0.164011,	  0.164407,	   0.164803,
		0.1652,		 0.165598,	  0.165996,	   0.166394,	0.166793,	 0.167192,	  0.167592,	   0.167992,
		0.168393,	 0.168794,	  0.169195,	   0.169598,	0.17,		 0.170403,	  0.170807,	   0.171211,
		0.171615,	 0.17202,	  0.172426,	   0.172832,	0.173238,	 0.173645,	  0.174052,	   0.17446,
		0.174869,	 0.175277,	  0.175687,	   0.176096,	0.176507,	 0.176917,	  0.177329,	   0.17774,
		0.178152,	 0.178565,	  0.178978,	   0.179392,	0.179806,	 0.18022,	  0.180635,	   0.181051,
		0.181467,	 0.181883,	  0.1823,	   0.182718,	0.183135,	 0.183554,	  0.183973,	   0.184392,
		0.184812,	 0.185232,	  0.185653,	   0.186074,	0.186496,	 0.186918,	  0.187341,	   0.187764,
		0.188187,	 0.188611,	  0.189036,	   0.189461,	0.189886,	 0.190312,	  0.190739,	   0.191166,
		0.191593,	 0.192021,	  0.19245,	   0.192878,	0.193308,	 0.193738,	  0.194168,	   0.194599,
		0.19503,	 0.195462,	  0.195894,	   0.196326,	0.19676,	 0.197193,	  0.197627,	   0.198062,
		0.198497,	 0.198933,	  0.199369,	   0.199805,	0.200242,	 0.200679,	  0.201117,	   0.201556,
		0.201995,	 0.202434,	  0.202874,	   0.203314,	0.203755,	 0.204196,	  0.204638,	   0.20508,
		0.205523,	 0.205966,	  0.20641,	   0.206854,	0.207299,	 0.207744,	  0.208189,	   0.208635,
		0.209082,	 0.209529,	  0.209976,	   0.210424,	0.210873,	 0.211321,	  0.211771,	   0.212221,
		0.212671,	 0.213122,	  0.213573,	   0.214025,	0.214477,	 0.21493,	  0.215383,	   0.215837,
		0.216291,	 0.216746,	  0.217201,	   0.217656,	0.218112,	 0.218569,	  0.219026,	   0.219483,
		0.219941,	 0.2204,	  0.220859,	   0.221318,	0.221778,	 0.222238,	  0.222699,	   0.22316,
		0.223622,	 0.224085,	  0.224547,	   0.22501,		0.225474,	 0.225938,	  0.226403,	   0.226868,
		0.227334,	 0.2278,	  0.228266,	   0.228733,	0.229201,	 0.229669,	  0.230137,	   0.230606,
		0.231076,	 0.231546,	  0.232016,	   0.232487,	0.232958,	 0.23343,	  0.233902,	   0.234375,
		0.234848,	 0.235322,	  0.235796,	   0.236271,	0.236746,	 0.237222,	  0.237698,	   0.238175,
		0.238652,	 0.239129,	  0.239607,	   0.240086,	0.240565,	 0.241044,	  0.241524,	   0.242004,
		0.242485,	 0.242967,	  0.243448,	   0.243931,	0.244414,	 0.244897,	  0.245381,	   0.245865,
		0.24635,	 0.246835,	  0.24732,	   0.247806,	0.248293,	 0.24878,	  0.249268,	   0.249756,
		0.250244,	 0.250733,	  0.251223,	   0.251713,	0.252203,	 0.252694,	  0.253185,	   0.253677,
		0.25417,	 0.254662,	  0.255156,	   0.25565,		0.256144,	 0.256638,	  0.257134,	   0.257629,
		0.258126,	 0.258622,	  0.259119,	   0.259617,	0.260115,	 0.260614,	  0.261113,	   0.261612,
		0.262112,	 0.262612,	  0.263113,	   0.263615,	0.264117,	 0.264619,	  0.265122,	   0.265625,
		0.266129,	 0.266633,	  0.267138,	   0.267643,	0.268149,	 0.268655,	  0.269162,	   0.269669,
		0.270177,	 0.270685,	  0.271193,	   0.271702,	0.272212,	 0.272722,	  0.273232,	   0.273743,
		0.274255,	 0.274766,	  0.275279,	   0.275792,	0.276305,	 0.276819,	  0.277333,	   0.277848,
		0.278363,	 0.278879,	  0.279395,	   0.279912,	0.280429,	 0.280947,	  0.281465,	   0.281983,
		0.282502,	 0.283022,	  0.283542,	   0.284062,	0.284583,	 0.285105,	  0.285627,	   0.286149,
		0.286672,	 0.287195,	  0.287719,	   0.288244,	0.288768,	 0.289294,	  0.289819,	   0.290346,
		0.290872,	 0.2914,	  0.291927,	   0.292455,	0.292984,	 0.293513,	  0.294043,	   0.294573,
		0.295103,	 0.295634,	  0.296166,	   0.296698,	0.29723,	 0.297763,	  0.298296,	   0.29883,
		0.299365,	 0.299899,	  0.300435,	   0.30097,		0.301507,	 0.302043,	  0.302581,	   0.303118,
		0.303656,	 0.304195,	  0.304734,	   0.305274,	0.305814,	 0.306354,	  0.306895,	   0.307437,
		0.307979,	 0.308521,	  0.309064,	   0.309608,	0.310152,	 0.310696,	  0.311241,	   0.311786,
		0.312332,	 0.312878,	  0.313425,	   0.313972,	0.31452,	 0.315068,	  0.315617,	   0.316166,
		0.316715,	 0.317266,	  0.317816,	   0.318367,	0.318919,	 0.319471,	  0.320023,	   0.320576,
		0.32113,	 0.321683,	  0.322238,	   0.322793,	0.323348,	 0.323904,	  0.32446,	   0.325017,
		0.325574,	 0.326132,	  0.32669,	   0.327249,	0.327808,	 0.328368,	  0.328928,	   0.329488,
		0.330049,	 0.330611,	  0.331173,	   0.331735,	0.332298,	 0.332862,	  0.333426,	   0.33399,
		0.334555,	 0.33512,	  0.335686,	   0.336253,	0.336819,	 0.337387,	  0.337954,	   0.338523,
		0.339091,	 0.339661,	  0.34023,	   0.3408,		0.341371,	 0.341942,	  0.342514,	   0.343086,
		0.343658,	 0.344231,	  0.344805,	   0.345379,	0.345953,	 0.346528,	  0.347103,	   0.347679,
		0.348256,	 0.348832,	  0.34941,	   0.349988,	0.350566,	 0.351145,	  0.351724,	   0.352303,
		0.352884,	 0.353464,	  0.354045,	   0.354627,	0.355209,	 0.355792,	  0.356375,	   0.356958,
		0.357542,	 0.358126,	  0.358711,	   0.359297,	0.359883,	 0.360469,	  0.361056,	   0.361643,
		0.362231,	 0.362819,	  0.363408,	   0.363997,	0.364587,	 0.365177,	  0.365768,	   0.366359,
		0.366951,	 0.367543,	  0.368135,	   0.368728,	0.369322,	 0.369916,	  0.37051,	   0.371105,
		0.371701,	 0.372297,	  0.372893,	   0.37349,		0.374087,	 0.374685,	  0.375283,	   0.375882,
		0.376481,	 0.377081,	  0.377681,	   0.378282,	0.378883,	 0.379485,	  0.380087,	   0.38069,
		0.381293,	 0.381896,	  0.3825,	   0.383105,	0.38371,	 0.384315,	  0.384921,	   0.385528,
		0.386134,	 0.386742,	  0.38735,	   0.387958,	0.388567,	 0.389176,	  0.389786,	   0.390396,
		0.391007,	 0.391618,	  0.39223,	   0.392842,	0.393454,	 0.394067,	  0.394681,	   0.395295,
		0.39591,	 0.396525,	  0.39714,	   0.397756,	0.398373,	 0.398989,	  0.399607,	   0.400225,
		0.400843,	 0.401462,	  0.402081,	   0.402701,	0.403321,	 0.403942,	  0.404563,	   0.405185,
		0.405807,	 0.40643,	  0.407053,	   0.407676,	0.4083,		 0.408925,	  0.40955,	   0.410176,
		0.410802,	 0.411428,	  0.412055,	   0.412682,	0.41331,	 0.413939,	  0.414567,	   0.415197,
		0.415827,	 0.416457,	  0.417088,	   0.417719,	0.418351,	 0.418983,	  0.419615,	   0.420249,
		0.420882,	 0.421516,	  0.422151,	   0.422786,	0.423421,	 0.424057,	  0.424694,	   0.425331,
		0.425968,	 0.426606,	  0.427245,	   0.427883,	0.428523,	 0.429163,	  0.429803,	   0.430444,
		0.431085,	 0.431727,	  0.432369,	   0.433012,	0.433655,	 0.434298,	  0.434943,	   0.435587,
		0.436232,	 0.436878,	  0.437524,	   0.43817,		0.438817,	 0.439465,	  0.440113,	   0.440761,
		0.44141,	 0.442059,	  0.442709,	   0.44336,		0.44401,	 0.444662,	  0.445313,	   0.445966,
		0.446618,	 0.447271,	  0.447925,	   0.448579,	0.449234,	 0.449889,	  0.450545,	   0.451201,
		0.451857,	 0.452514,	  0.453172,	   0.45383,		0.454488,	 0.455147,	  0.455806,	   0.456466,
		0.457127,	 0.457787,	  0.458449,	   0.459111,	0.459773,	 0.460436,	  0.461099,	   0.461762,
		0.462427,	 0.463091,	  0.463756,	   0.464422,	0.465088,	 0.465755,	  0.466422,	   0.467089,
		0.467757,	 0.468426,	  0.469095,	   0.469764,	0.470434,	 0.471104,	  0.471775,	   0.472446,
		0.473118,	 0.47379,	  0.474463,	   0.475136,	0.47581,	 0.476484,	  0.477159,	   0.477834,
		0.47851,	 0.479186,	  0.479862,	   0.48054,		0.481217,	 0.481895,	  0.482574,	   0.483253,
		0.483932,	 0.484612,	  0.485292,	   0.485973,	0.486654,	 0.487336,	  0.488019,	   0.488701,
		0.489385,	 0.490068,	  0.490753,	   0.491437,	0.492122,	 0.492808,	  0.493494,	   0.494181,
		0.494868,	 0.495555,	  0.496244,	   0.496932,	0.497621,	 0.49831,	  0.499,	   0.499691,
		0.500382,	 0.501073,	  0.501765,	   0.502457,	0.50315,	 0.503843,	  0.504537,	   0.505231,
		0.505926,	 0.506621,	  0.507317,	   0.508013,	0.50871,	 0.509407,	  0.510104,	   0.510802,
		0.511501,	 0.5122,	  0.512899,	   0.513599,	0.5143,		 0.515001,	  0.515702,	   0.516404,
		0.517106,	 0.517809,	  0.518513,	   0.519216,	0.519921,	 0.520625,	  0.521331,	   0.522036,
		0.522742,	 0.523449,	  0.524156,	   0.524864,	0.525572,	 0.52628,	  0.526989,	   0.527699,
		0.528409,	 0.529119,	  0.52983,	   0.530542,	0.531254,	 0.531966,	  0.532679,	   0.533392,
		0.534106,	 0.53482,	  0.535535,	   0.53625,		0.536966,	 0.537682,	  0.538399,	   0.539116,
		0.539834,	 0.540552,	  0.54127,	   0.541989,	0.542709,	 0.543429,	  0.544149,	   0.54487,
		0.545592,	 0.546314,	  0.547036,	   0.547759,	0.548482,	 0.549206,	  0.549931,	   0.550655,
		0.551381,	 0.552106,	  0.552833,	   0.553559,	0.554286,	 0.555014,	  0.555742,	   0.556471,
		0.5572,		 0.557929,	  0.558659,	   0.55939,		0.560121,	 0.560852,	  0.561584,	   0.562317,
		0.56305,	 0.563783,	  0.564517,	   0.565251,	0.565986,	 0.566721,	  0.567457,	   0.568193,
		0.56893,	 0.569667,	  0.570405,	   0.571143,	0.571882,	 0.572621,	  0.57336,	   0.5741,
		0.574841,	 0.575582,	  0.576324,	   0.577065,	0.577808,	 0.578551,	  0.579294,	   0.580038,
		0.580782,	 0.581527,	  0.582273,	   0.583018,	0.583765,	 0.584511,	  0.585259,	   0.586006,
		0.586755,	 0.587503,	  0.588252,	   0.589002,	0.589752,	 0.590503,	  0.591254,	   0.592005,
		0.592757,	 0.59351,	  0.594262,	   0.595016,	0.59577,	 0.596524,	  0.597279,	   0.598034,
		0.59879,	 0.599546,	  0.600303,	   0.60106,		0.601818,	 0.602576,	  0.603335,	   0.604094,
		0.604854,	 0.605614,	  0.606375,	   0.607136,	0.607897,	 0.608659,	  0.609422,	   0.610185,
		0.610948,	 0.611712,	  0.612476,	   0.613241,	0.614007,	 0.614772,	  0.615539,	   0.616306,
		0.617073,	 0.617841,	  0.618609,	   0.619377,	0.620147,	 0.620916,	  0.621686,	   0.622457,
		0.623228,	 0.624,		  0.624772,	   0.625544,	0.626317,	 0.627091,	  0.627865,	   0.628639,
		0.629414,	 0.630189,	  0.630965,	   0.631742,	0.632518,	 0.633296,	  0.634073,	   0.634852,
		0.63563,	 0.63641,	  0.637189,	   0.637969,	0.63875,	 0.639531,	  0.640313,	   0.641095,
		0.641877,	 0.64266,	  0.643444,	   0.644228,	0.645012,	 0.645797,	  0.646583,	   0.647368,
		0.648155,	 0.648942,	  0.649729,	   0.650517,	0.651305,	 0.652094,	  0.652883,	   0.653673,
		0.654463,	 0.655253,	  0.656045,	   0.656836,	0.657628,	 0.658421,	  0.659214,	   0.660007,
		0.660801,	 0.661596,	  0.662391,	   0.663186,	0.663982,	 0.664779,	  0.665575,	   0.666373,
		0.667171,	 0.667969,	  0.668768,	   0.669567,	0.670367,	 0.671167,	  0.671967,	   0.672769,
		0.67357,	 0.674372,	  0.675175,	   0.675978,	0.676781,	 0.677585,	  0.67839,	   0.679195,
		0.68,		 0.680806,	  0.681613,	   0.68242,		0.683227,	 0.684035,	  0.684843,	   0.685652,
		0.686461,	 0.687271,	  0.688081,	   0.688892,	0.689703,	 0.690515,	  0.691327,	   0.692139,
		0.692953,	 0.693766,	  0.69458,	   0.695395,	0.69621,	 0.697025,	  0.697841,	   0.698657,
		0.699474,	 0.700292,	  0.70111,	   0.701928,	0.702747,	 0.703566,	  0.704386,	   0.705206,
		0.706027,	 0.706848,	  0.70767,	   0.708492,	0.709314,	 0.710138,	  0.710961,	   0.711785,
		0.71261,	 0.713435,	  0.71426,	   0.715086,	0.715913,	 0.71674,	  0.717567,	   0.718395,
		0.719223,	 0.720052,	  0.720881,	   0.721711,	0.722542,	 0.723372,	  0.724203,	   0.725035,
		0.725867,	 0.7267,	  0.727533,	   0.728367,	0.729201,	 0.730035,	  0.73087,	   0.731706,
		0.732542,	 0.733378,	  0.734215,	   0.735053,	0.735891,	 0.736729,	  0.737568,	   0.738407,
		0.739247,	 0.740087,	  0.740928,	   0.741769,	0.742611,	 0.743453,	  0.744296,	   0.745139,
		0.745983,	 0.746827,	  0.747671,	   0.748517,	0.749362,	 0.750208,	  0.751055,	   0.751902,
		0.752749,	 0.753597,	  0.754445,	   0.755294,	0.756144,	 0.756993,	  0.757844,	   0.758695,
		0.759546,	 0.760398,	  0.76125,	   0.762102,	0.762956,	 0.763809,	  0.764663,	   0.765518,
		0.766373,	 0.767229,	  0.768085,	   0.768941,	0.769798,	 0.770656,	  0.771514,	   0.772372,
		0.773231,	 0.774091,	  0.77495,	   0.775811,	0.776672,	 0.777533,	  0.778395,	   0.779257,
		0.78012,	 0.780983,	  0.781846,	   0.782711,	0.783575,	 0.78444,	  0.785306,	   0.786172,
		0.787039,	 0.787906,	  0.788773,	   0.789641,	0.79051,	 0.791378,	  0.792248,	   0.793118,
		0.793988,	 0.794859,	  0.79573,	   0.796602,	0.797474,	 0.798347,	  0.79922,	   0.800094,
		0.800968,	 0.801843,	  0.802718,	   0.803594,	0.80447,	 0.805346,	  0.806223,	   0.807101,
		0.807979,	 0.808857,	  0.809736,	   0.810616,	0.811496,	 0.812376,	  0.813257,	   0.814138,
		0.81502,	 0.815902,	  0.816785,	   0.817668,	0.818552,	 0.819436,	  0.820321,	   0.821206,
		0.822092,	 0.822978,	  0.823864,	   0.824751,	0.825639,	 0.826527,	  0.827416,	   0.828305,
		0.829194,	 0.830084,	  0.830974,	   0.831865,	0.832757,	 0.833648,	  0.834541,	   0.835434,
		0.836327,	 0.837221,	  0.838115,	   0.83901,		0.839905,	 0.8408,	  0.841697,	   0.842593,
		0.84349,	 0.844388,	  0.845286,	   0.846184,	0.847083,	 0.847983,	  0.848883,	   0.849783,
		0.850684,	 0.851586,	  0.852487,	   0.85339,		0.854293,	 0.855196,	  0.8561,	   0.857004,
		0.857909,	 0.858814,	  0.859719,	   0.860626,	0.861532,	 0.862439,	  0.863347,	   0.864255,
		0.865164,	 0.866073,	  0.866982,	   0.867892,	0.868802,	 0.869713,	  0.870625,	   0.871537,
		0.872449,	 0.873362,	  0.874275,	   0.875189,	0.876103,	 0.877018,	  0.877933,	   0.878849,
		0.879765,	 0.880682,	  0.881599,	   0.882517,	0.883435,	 0.884353,	  0.885272,	   0.886192,
		0.887112,	 0.888032,	  0.888953,	   0.889875,	0.890797,	 0.891719,	  0.892642,	   0.893565,
		0.894489,	 0.895413,	  0.896338,	   0.897263,	0.898189,	 0.899115,	  0.900042,	   0.900969,
		0.901897,	 0.902825,	  0.903754,	   0.904683,	0.905612,	 0.906542,	  0.907473,	   0.908404,
		0.909335,	 0.910267,	  0.911199,	   0.912132,	0.913066,	 0.914,		  0.914934,	   0.915869,
		0.916804,	 0.91774,	  0.918676,	   0.919613,	0.92055,	 0.921487,	  0.922426,	   0.923364,
		0.924303,	 0.925243,	  0.926183,	   0.927123,	0.928064,	 0.929006,	  0.929948,	   0.93089,
		0.931833,	 0.932777,	  0.933721,	   0.934665,	0.93561,	 0.936555,	  0.937501,	   0.938447,
		0.939394,	 0.940341,	  0.941289,	   0.942237,	0.943185,	 0.944135,	  0.945084,	   0.946034,
		0.946985,	 0.947936,	  0.948887,	   0.949839,	0.950792,	 0.951745,	  0.952698,	   0.953652,
		0.954606,	 0.955561,	  0.956517,	   0.957472,	0.958429,	 0.959385,	  0.960343,	   0.9613,
		0.962258,	 0.963217,	  0.964176,	   0.965136,	0.966096,	 0.967057,	  0.968018,	   0.968979,
		0.969941,	 0.970904,	  0.971867,	   0.97283,		0.973794,	 0.974758,	  0.975723,	   0.976689,
		0.977654,	 0.978621,	  0.979587,	   0.980555,	0.981522,	 0.982491,	  0.983459,	   0.984428,
		0.985398,	 0.986368,	  0.987339,	   0.98831,		0.989281,	 0.990253,	  0.991226,	   0.992199,
		0.993172,	 0.994146,	  0.995121,	   0.996096,	0.997071,	 0.998047,	  0.999023,	   1};
	int stage = 0;
	int sampleRate = 48000;
	uint32_t phaccu = 0;
	uint32_t lastPhaccu = 0;
	uint32_t increment = 0;
	static constexpr uint32_t max_ = 0xFFFFFFFF;
	float envTimes[4] = {1000, 1000, 1000, 1000};
	float sustainLevel = 0.5f;
	float lastSample = 0;
	float envOut = 0;
	float attackCurve = 0;
	float decayCurve = 0;
	float releaseCurve = 0;
	bool holdEnable = true;

	bool lastGate;
	WindowComparator gateInput;

	float calcRise(float curve)
	{
		float rise = 0;
		auto linearCurve = (float)phaccu / (float)max_;
		if (curve <= 0.5f) {
			auto expoRise = expoCurve[phaccu >> 21];
			rise = interpolate(expoRise, linearCurve, curve * 2.0f);
		}

		return (rise);
	}

	float calcFall(float fallFrom, float fallTo, float curve)
	{
		return (map_value((float)phaccu / (float)max_, 0.0f, 1.0f, fallFrom, fallTo));
	}

public:
	bool sustainEnable = true;
	Envelope() {}
	float update(float input)
	{
		lastGate = gateInput.get_output();
		gateInput.update(input);
		if (gateInput.get_output() > lastGate) {
			phaccu = 0;
			stage = 0;
		}
		if (gateInput.get_output() < lastGate) {
			if (sustainEnable) {
				phaccu = 0;
				stage = 4;
			}
		}
		int stageSelect = 0;
		if (sustainEnable) {
			if (stage < 3)
				stageSelect = stage;
			else {
				stageSelect = 3;
			}
		} else {
			stageSelect = stage;
		}

		increment = 1000.0f / envTimes[stageSelect] * (max_ / sampleRate);

		lastPhaccu = phaccu;
		phaccu += increment;
		if (phaccu < lastPhaccu) // overflow
		{
			if (stage == 0) {
				if (holdEnable) {
					stage = 1;
				} else {
					stage = 2;
				}

			} else {
				if (sustainEnable) {
					if (stage < 3 || stage == 4)
						stage++;
				} else {
					stage++;
				}
			}
		}
		if (stage == 0) {
			envOut = calcRise(attackCurve);
		} else if (stage == 1) {
			envOut = 1.0f;
		} else if (stage == 2) {
			envOut = calcFall(1.0f, sustainLevel, decayCurve);
		}

		if (sustainEnable) {
			if (stage == 3) {
				envOut = sustainLevel;
			} else if (stage == 4) {
				envOut = calcFall(lastSample, 0.0f, releaseCurve);
			}
		} else {
			if (stage == 3) {
				envOut = calcFall(sustainLevel, 0.0f, releaseCurve);
			}
		}

		if (stage < 4)
			lastSample = envOut;
		return envOut;
	}

	void set_envelope_time(int _envStage, float milliseconds)
	{
		envTimes[_envStage] = milliseconds;
	}

	void set_samplerate(float sr)
	{
		sampleRate = sr;
	}

	void set_sustain(float _sustainLevel)
	{
		sustainLevel = _sustainLevel;
	}

	void set_attack_curve(float val)
	{
		attackCurve = val;
	}

	void set_decay_curve(float val)
	{
		decayCurve = val;
	}

	void set_release_curve(float val)
	{
		releaseCurve = val;
	}
};